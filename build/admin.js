(()=>{"use strict";const e=window.React,t=window.wp.element,a=window.wp.i18n,s=window.wp.components,n=()=>`ls-${Math.random().toString(36).slice(2,8)}${Date.now().toString(36).slice(-4)}`,l=()=>{const e=Boolean(window?.chrome&&window.chrome.runtime);return{userAgent:"undefined"==typeof navigator?"":navigator.userAgent||"",hasChromeRuntime:e,suggestion:"Test in private browsing to isolate extensions."}},r=({debugEnabled:e=!1,prefix:t="[LeanStats]"}={})=>{const a=()=>"function"==typeof e?e():e,s=(e,s,n,l=!1)=>{(l||a())&&((e,a,s)=>{const n=`${t} ${a}`;console&&console.groupCollapsed?(console.groupCollapsed(n),console[e](s),console.groupEnd()):console[e](n,s)})(e,s,{time:"undefined"!=typeof performance&&performance.now?Number(performance.now().toFixed(2)):Date.now(),page:"undefined"!=typeof window&&window.location&&window.location.pathname||"",...n})};return{debug:(e,t={})=>s("debug",e,t),info:(e,t={})=>s("info",e,t),warn:(e,t={})=>s("warn",e,t),error:(e,n={})=>{a()?s("error",e,n,!0):console&&console.error&&console.error(`${t} ${e}`)},isDebugEnabled:()=>e}},i=({height:a,ariaLabel:s,children:n})=>{const{ref:l,hasSize:r}=(()=>{const e=(0,t.useRef)(null),[a,s]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{const t=e.current;if(!t)return;const a=()=>{const e=t.getBoundingClientRect(),a=e.width>0&&e.height>0;s(e=>e===a?e:a)};let n;return a(),window.ResizeObserver?(n=new ResizeObserver(()=>a()),n.observe(t)):window.addEventListener("resize",a),()=>{n?n.disconnect():window.removeEventListener("resize",a)}},[]),{ref:e,hasSize:a}})();return(0,e.createElement)("div",{ref:l,className:"ls-chart-frame","data-height":a,role:"img","aria-label":s},r?n:null)},o=["ls-skeleton__bar--w80","ls-skeleton__bar--w74","ls-skeleton__bar--w68","ls-skeleton__bar--w62","ls-skeleton__bar--w56","ls-skeleton__bar--w50"],c=({isLoading:t,error:n,isEmpty:l,emptyLabel:r,loadingLabel:i=(0,a.__)("Loading…","lean-stats"),skeletonRows:c=4})=>{if(t){const t=Array.from({length:c},(e,t)=>t);return(0,e.createElement)("div",{className:"ls-data-state","aria-live":"polite","aria-busy":"true"},(0,e.createElement)("div",{className:"ls-data-state__header"},(0,e.createElement)(s.Spinner,null),(0,e.createElement)("span",null,i)),(0,e.createElement)("div",{className:"ls-skeleton"},t.map(t=>(0,e.createElement)("div",{key:t,className:`ls-skeleton__bar ${o[Math.min(t,o.length-1)]}`}))))}return n?(0,e.createElement)(s.Notice,{status:"error",isDismissible:!1},n):l?(0,e.createElement)("p",{role:"status"},r):null},d=({title:t,children:a,...n})=>(0,e.createElement)(s.Card,{...n},t?(0,e.createElement)(s.CardHeader,null,(0,e.createElement)("strong",null,t)):null,(0,e.createElement)(s.CardBody,null,a)),m=window.LeanStatsAdmin||null,_=()=>{var e;return Boolean(null!==(e=window.LEAN_STATS_DEBUG)&&void 0!==e?e:m?.settings?.debugEnabled)},g=[{name:"dashboard",title:(0,a.__)("Dashboard","lean-stats")},{name:"settings",title:(0,a.__)("Settings","lean-stats")}],u={plugin_label:"",strict_mode:!1,respect_dnt_gpc:!0,url_strip_query:!0,url_query_allowlist:[],raw_logs_enabled:!1,raw_logs_retention_days:1,excluded_roles:[],excluded_paths:[],debug_enabled:!1},p=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,b=(e,t,a)=>{const s=m?.restUrl?`${m.restUrl}`:"",n=new URL(`${null!=a?a:m?.settings?.restInternalNamespace||""}${e}`,s);return t&&Object.entries(t).forEach(([e,t])=>{null!=t&&""!==t&&n.searchParams.set(e,t)}),n.toString()},h=(e,s,l={})=>{const[i,o]=(0,t.useState)(null),[c,d]=(0,t.useState)(!0),[g,u]=(0,t.useState)(null),p=(0,t.useMemo)(()=>JSON.stringify(null!=s?s:{}),[s]),h=(0,t.useMemo)(()=>r({debugEnabled:_}),[]),{enabled:E=!0,namespace:w=m?.settings?.restInternalNamespace}=l;return(0,t.useEffect)(()=>{if(!E||!e)return d(!1),u(null),void o(null);let t=!0;const l=new AbortController,r=n();return(async()=>{if(!m?.restNonce||!m?.restUrl)return u((0,a.__)("Missing REST configuration.","lean-stats")),void d(!1);d(!0),u(null),h.debug("Loading admin data",{action:"admin.fetch",traceId:r,path:e,params:s});try{const n=await fetch(b(e,s,w),{signal:l.signal,headers:{"X-WP-Nonce":m.restNonce}});if(!n.ok)throw new Error((0,a.sprintf)((0,a.__)("API error (%s)","lean-stats"),n.status));const i=await n.json();t&&o(i),h.debug("Admin data received",{action:"admin.fetch.success",traceId:r,path:e})}catch(s){t&&"AbortError"!==s.name?(u(s.message||(0,a.__)("Loading error.","lean-stats")),h.error("Admin load error",{action:"admin.fetch.error",traceId:r,path:e,error:s?.message})):"AbortError"===s.name&&h.debug("Admin load cancelled",{action:"admin.fetch.abort",traceId:r,path:e})}finally{t&&d(!1)}})(),()=>{t=!1,l.abort()}},[e,p,E]),{data:i,isLoading:c,error:g}},E=e=>{const t={...u,...e||{}},a=Boolean(t.debug_enabled||t.raw_logs_enabled);return{...t,debug_enabled:a,raw_logs_enabled:a}},w=({debugEnabled:t})=>{const{data:n,isLoading:l,error:r}=h("/admin/raw-logs",{limit:50},{enabled:t}),i=n?.items||[];return t?(0,e.createElement)("div",{className:"ls-settings-logs"},(0,e.createElement)(c,{isLoading:l,error:r,isEmpty:!l&&!r&&0===i.length,emptyLabel:(0,a.__)("No raw logs available.","lean-stats"),loadingLabel:(0,a.__)("Loading raw logs…","lean-stats"),skeletonRows:4}),!l&&!r&&i.length>0&&(0,e.createElement)("table",{className:"widefat striped ls-settings-logs__table"},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",null,(0,a.__)("Date","lean-stats")),(0,e.createElement)("th",null,(0,a.__)("Page","lean-stats")),(0,e.createElement)("th",null,(0,a.__)("Referrer","lean-stats")),(0,e.createElement)("th",null,(0,a.__)("Device","lean-stats")))),(0,e.createElement)("tbody",null,i.map((t,s)=>{return(0,e.createElement)("tr",{key:`${t.timestamp_bucket}-${s}`},(0,e.createElement)("td",null,(n=t.timestamp_bucket)?new Date(1e3*n).toLocaleString():""),(0,e.createElement)("td",null,t.page_path),(0,e.createElement)("td",null,t.referrer_domain||(0,a.__)("Direct","lean-stats")),(0,e.createElement)("td",null,t.device_class||"-"));var n})))):(0,e.createElement)(s.Notice,{status:"warning",isDismissible:!1},(0,a.__)("Enable debug mode to display raw logs.","lean-stats"))},v=({value:t,onChange:n})=>(0,e.createElement)(s.Card,{className:"ls-overview__summary-card ls-overview__summary-card--filter"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)(s.SelectControl,{label:(0,a.__)("Period","lean-stats"),value:t,options:[{label:(0,a.__)("7 days","lean-stats"),value:"7d"},{label:(0,a.__)("30 days","lean-stats"),value:"30d"},{label:(0,a.__)("90 days","lean-stats"),value:"90d"}],onChange:n,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}))),y=()=>{const{data:l,isLoading:i,error:o}=h("/admin/settings"),[g,p]=(0,t.useState)(u),[v,y]=(0,t.useState)(""),[f,N]=(0,t.useState)(""),[k,S]=(0,t.useState)(!1),[C,L]=(0,t.useState)(null),[x,D]=(0,t.useState)(!1),[B,A]=(0,t.useState)(!1),[P,T]=(0,t.useState)(null),R=(0,t.useMemo)(()=>r({debugEnabled:_}),[]),M=Boolean(g.debug_enabled),$=(0,t.useMemo)(()=>[(0,a.__)("Aggregated page views by URL path.","lean-stats"),(0,a.__)("Aggregated referrer domains.","lean-stats"),(0,a.__)("Aggregated device class totals.","lean-stats"),(0,a.__)("Aggregated 404 paths.","lean-stats"),(0,a.__)("Aggregated on-site search terms.","lean-stats"),(0,a.__)("Raw log snapshots (timestamp, page path, referrer, device) when debug mode is enabled.","lean-stats")],[]),I=(0,t.useMemo)(()=>{const e=[];return g.respect_dnt_gpc||e.push((0,a.__)("Tracking continues even when browsers send DNT or GPC.","lean-stats")),g.url_strip_query||e.push((0,a.__)("Full query strings remain in stored page paths.","lean-stats")),g.raw_logs_enabled&&e.push((0,a.__)("Raw logs store granular hit details while debug mode is enabled.","lean-stats")),g.raw_logs_retention_days>30&&e.push((0,a.__)("Raw log retention exceeds 30 days.","lean-stats")),e},[g]);(0,t.useEffect)(()=>{if(l?.settings){const e=E(l.settings);p(e),y(e.url_query_allowlist.join(", ")),N(e.excluded_paths.join("\n")),window.LEAN_STATS_DEBUG=Boolean(e.debug_enabled)}},[l]);const U=async()=>{if(!m?.restNonce||!m?.restUrl)return void L({status:"error",message:(0,a.__)("Missing REST configuration.","lean-stats")});S(!0),L(null);const e=n();R.info("Saving settings",{action:"settings.save",traceId:e});try{const t=await fetch(b("/admin/settings"),{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":m.restNonce},body:JSON.stringify(g)});if(!t.ok)throw new Error((0,a.sprintf)((0,a.__)("API error (%s)","lean-stats"),t.status));const s=await t.json();if(s?.settings){const e=E(s.settings);p(e),y(e.url_query_allowlist.join(", ")),N(e.excluded_paths.join("\n")),window.LEAN_STATS_DEBUG=Boolean(e.debug_enabled)}L({status:"success",message:(0,a.__)("Settings saved.","lean-stats")}),R.info("Settings saved",{action:"settings.save.success",traceId:e})}catch(t){L({status:"error",message:t.message||(0,a.__)("Error while saving.","lean-stats")}),R.error("Settings save error",{action:"settings.save.error",traceId:e,error:t?.message})}finally{S(!1)}},q=async()=>{if(!m?.restNonce||!m?.restUrl)return void T({status:"error",message:(0,a.__)("Missing REST configuration.","lean-stats")});A(!0),T(null);const e=n();R.info("Purging analytics data",{action:"settings.purge",traceId:e});try{const t=await fetch(b("/admin/purge-data"),{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":m.restNonce}});if(!t.ok)throw new Error((0,a.sprintf)((0,a.__)("API error (%s)","lean-stats"),t.status));await t.json(),T({status:"success",message:(0,a.__)("Analytics data purged.","lean-stats")}),R.info("Analytics data purged",{action:"settings.purge.success",traceId:e})}catch(t){T({status:"error",message:t.message||(0,a.__)("Error while purging.","lean-stats")}),R.error("Purge error",{action:"settings.purge.error",traceId:e,error:t?.message})}finally{A(!1),D(!1)}},j=m?.roles||[],F=[{name:"general",title:(0,a.__)("General","lean-stats")},...M?[{name:"logs",title:(0,a.__)("Logs","lean-stats")}]:[]];return(0,e.createElement)(d,{title:(0,a.__)("Settings","lean-stats")},(0,e.createElement)(c,{isLoading:i,error:o,isEmpty:!1,emptyLabel:"",loadingLabel:(0,a.__)("Loading settings…","lean-stats"),skeletonRows:6}),!i&&!o&&(0,e.createElement)(s.TabPanel,{tabs:F},t=>"logs"===t.name?(0,e.createElement)(w,{debugEnabled:M}):(0,e.createElement)("div",{className:"ls-settings-form"},C&&(0,e.createElement)(s.Notice,{status:C.status,isDismissible:!1},C.message),P&&(0,e.createElement)(s.Notice,{status:P.status,isDismissible:!1},P.message),(0,e.createElement)(s.Card,{className:"ls-settings-section"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,a.__)("General","lean-stats")),(0,e.createElement)(s.TextControl,{label:(0,a.__)("Plugin name (menu and dashboard)","lean-stats"),help:(0,a.__)('Leave blank to use "Lean Stats".',"lean-stats"),value:g.plugin_label,onChange:e=>p(t=>({...t,plugin_label:e}))}),(0,e.createElement)(s.ToggleControl,{label:(0,a.__)("Strict mode","lean-stats"),help:(0,a.__)("Ignore tracking for logged-in users.","lean-stats"),checked:g.strict_mode,onChange:e=>p(t=>({...t,strict_mode:e}))}))),(0,e.createElement)(s.Card,{className:"ls-settings-section"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,a.__)("Privacy & consent","lean-stats")),(0,e.createElement)(s.ToggleControl,{label:(0,a.__)("Respect DNT / GPC","lean-stats"),help:(0,a.__)("Ignore tracking if the browser sends DNT or GPC.","lean-stats"),checked:g.respect_dnt_gpc,onChange:e=>p(t=>({...t,respect_dnt_gpc:e}))}),(0,e.createElement)(s.ToggleControl,{label:(0,a.__)("Debug mode","lean-stats"),help:(0,a.__)("Enables detailed console logs and raw log capture.","lean-stats"),checked:g.debug_enabled,onChange:e=>p(t=>({...t,debug_enabled:e,raw_logs_enabled:e}))}),(0,e.createElement)(s.TextControl,{label:(0,a.__)("Retention window (days)","lean-stats"),type:"number",min:1,max:365,value:String(g.raw_logs_retention_days),help:(0,a.__)("Raw logs purge automatically after the configured window.","lean-stats"),onChange:e=>{const t=Number.parseInt(e,10);p(e=>({...e,raw_logs_retention_days:Number.isNaN(t)?e.raw_logs_retention_days:t}))}}))),(0,e.createElement)(s.Card,{className:"ls-settings-section"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,a.__)("URL cleaning","lean-stats")),(0,e.createElement)(s.ToggleControl,{label:(0,a.__)("Strip query parameters","lean-stats"),help:(0,a.__)("Remove query parameters from tracked URLs.","lean-stats"),checked:g.url_strip_query,onChange:e=>p(t=>({...t,url_strip_query:e}))}),(0,e.createElement)(s.TextControl,{label:(0,a.__)("Query parameter allowlist","lean-stats"),help:(0,a.__)("Comma-separated list (e.g., utm_source, utm_campaign).","lean-stats"),value:v,onChange:e=>{y(e);const t=e.split(",").map(e=>e.trim()).filter(Boolean);p(e=>({...e,url_query_allowlist:t}))}}))),(0,e.createElement)(s.Card,{className:"ls-settings-section"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,a.__)("Exclusions","lean-stats")),(0,e.createElement)(s.TextareaControl,{label:(0,a.__)("Excluded paths","lean-stats"),help:(0,a.__)("One per line or comma-separated (e.g., /privacy, /account).","lean-stats"),value:f,onChange:e=>{N(e);const t=e.split(/[\n,]+/).map(e=>e.trim()).filter(Boolean);p(e=>({...e,excluded_paths:t}))}}),(0,e.createElement)("div",null,(0,e.createElement)("p",{className:"ls-settings-roles__title"},(0,a.__)("Role exclusions","lean-stats")),(0,e.createElement)("div",{className:"ls-settings-roles__list"},0===j.length&&(0,e.createElement)("p",null,(0,a.__)("No roles available.","lean-stats")),j.map(t=>(0,e.createElement)(s.CheckboxControl,{key:t.key,label:t.label,checked:g.excluded_roles.includes(t.key),onChange:e=>{p(a=>{const s=new Set(a.excluded_roles);return e?s.add(t.key):s.delete(t.key),{...a,excluded_roles:Array.from(s)}})}})))))),(0,e.createElement)(s.Card,{className:"ls-settings-section"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,a.__)("Privacy checklist","lean-stats")),(0,e.createElement)("ul",{className:"ls-settings-privacy__list"},$.map(t=>(0,e.createElement)("li",{key:t},t))),I.length>0&&(0,e.createElement)(s.Notice,{status:"warning",isDismissible:!1},(0,e.createElement)("p",null,(0,a.__)("Review these privacy risks:","lean-stats")),(0,e.createElement)("ul",{className:"ls-settings-privacy__warnings"},I.map(t=>(0,e.createElement)("li",{key:t},t)))))),(0,e.createElement)(s.Card,{className:"ls-settings-section"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,a.__)("Data management","lean-stats")),(0,e.createElement)("p",null,(0,a.__)("Remove all aggregated analytics and raw log entries.","lean-stats")),(0,e.createElement)(s.Button,{variant:"secondary",isDestructive:!0,onClick:()=>D(!0)},(0,a.__)("Purge analytics data","lean-stats")))),(0,e.createElement)(s.Button,{variant:"primary",isBusy:k,onClick:U,"aria-label":(0,a.__)("Save settings","lean-stats")},(0,a.__)("Save","lean-stats")),x&&(0,e.createElement)(s.Modal,{title:(0,a.__)("Confirm data purge","lean-stats"),onRequestClose:()=>D(!1)},(0,e.createElement)("p",null,(0,a.__)("This action permanently removes all stored analytics and raw logs. Settings remain unchanged.","lean-stats")),(0,e.createElement)("div",{className:"ls-settings-modal__actions"},(0,e.createElement)(s.Button,{variant:"secondary",onClick:()=>D(!1)},(0,a.__)("Cancel","lean-stats")),(0,e.createElement)(s.Button,{variant:"primary",isDestructive:!0,isBusy:B,onClick:q},(0,a.__)("Purge now","lean-stats")))))))},f=({range:t})=>{const{data:n,isLoading:l,error:r}=h("/overview",t,{namespace:m?.settings?.restNamespace}),i=n?.overview||null,o=!l&&!r&&!i;if(l||r||o)return(0,e.createElement)(s.Card,{className:"ls-overview__summary-card ls-overview__summary-card--status"},(0,e.createElement)(s.CardBody,null,(0,e.createElement)(c,{isLoading:l,error:r,isEmpty:o,emptyLabel:(0,a.__)("No overview data available.","lean-stats"),loadingLabel:(0,a.__)("Loading overview…","lean-stats"),skeletonRows:3})));const d=[{label:(0,a.__)("Pageviews (hits)","lean-stats"),value:i.pageViews,icon:"chart-bar"},{label:(0,a.__)("Unique pages","lean-stats"),value:i.uniquePages,icon:"admin-page"},{label:(0,a.__)("Unique referrers","lean-stats"),value:i.uniqueReferrers,icon:"admin-links"},{label:(0,a.__)("404 hits","lean-stats"),value:i.notFoundHits,icon:"warning"},{label:(0,a.__)("Search hits","lean-stats"),value:i.searchHits,icon:"search"},{label:(0,a.__)("Unique search terms","lean-stats"),value:i.uniqueSearchTerms,icon:"search"}];return(0,e.createElement)(e.Fragment,null,d.map(t=>(0,e.createElement)(s.Card,{key:t.label,className:"ls-overview__summary-card"},(0,e.createElement)(s.CardBody,{className:"ls-kpi-card__body"},(0,e.createElement)("span",{className:`dashicons dashicons-${t.icon} ls-kpi-card__icon`,"aria-hidden":"true"}),(0,e.createElement)("div",{className:"ls-kpi-card__content"},(0,e.createElement)("p",{className:"ls-kpi-card__label"},t.label),(0,e.createElement)("strong",{className:"ls-kpi-card__value"},t.value))))))},N=({range:s})=>{const{data:n,isLoading:l,error:r}=h("/admin/timeseries/day",s),o=n?.items||[],m=(0,t.useMemo)(()=>(e=>{const t=e.reduce((e,t)=>Math.max(e,t.hits),0),a=Math.max(576,1),s=Math.max(176,1),n=Math.max(e.length-1,1),l=e.map((e,l)=>({x:32+a*l/n,y:208-(t?e.hits/t*s:0),label:e.bucket,hits:e.hits})),r=l.map((e,t)=>`${0===t?"M":"L"} ${e.x} ${e.y}`).join(" ");return{points:l,path:r,maxHits:t,width:640,height:240,padding:32}})(o),[o]);return(0,e.createElement)(d,{title:(0,a.__)("Daily pageviews (hits)","lean-stats")},(0,e.createElement)(c,{isLoading:l,error:r,isEmpty:!l&&!r&&0===o.length,emptyLabel:(0,a.__)("No data available for this period.","lean-stats"),loadingLabel:(0,a.__)("Loading chart…","lean-stats")}),!l&&!r&&o.length>0&&(0,e.createElement)("div",{className:"ls-timeseries"},(0,e.createElement)(i,{height:240,ariaLabel:(0,a.__)("Daily pageviews line chart","lean-stats")},(0,e.createElement)("svg",{viewBox:`0 0 ${m.width} ${m.height}`,className:"ls-timeseries__svg",role:"img","aria-label":(0,a.__)("Daily pageviews line chart","lean-stats")},(0,e.createElement)("rect",{x:"0",y:"0",width:m.width,height:m.height,className:"ls-timeseries__bg"}),(0,e.createElement)("line",{x1:m.padding,y1:m.padding,x2:m.padding,y2:m.height-m.padding,className:"ls-timeseries__axis"}),(0,e.createElement)("line",{x1:m.padding,y1:m.height-m.padding,x2:m.width-m.padding,y2:m.height-m.padding,className:"ls-timeseries__axis"}),(0,e.createElement)("path",{d:m.path,className:"ls-timeseries__line"}),m.points.map(t=>(0,e.createElement)("circle",{key:`${t.label}-${t.hits}`,cx:t.x,cy:t.y,r:"3",className:"ls-timeseries__point"})))),(0,e.createElement)("table",{className:"widefat striped ls-timeseries__table","aria-label":(0,a.__)("Daily series table","lean-stats")},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",null,(0,a.__)("Date","lean-stats")),(0,e.createElement)("th",null,(0,a.__)("Pageviews (hits)","lean-stats")))),(0,e.createElement)("tbody",null,o.map(t=>(0,e.createElement)("tr",{key:t.bucket},(0,e.createElement)("td",null,t.bucket),(0,e.createElement)("td",null,t.hits)))))))},k=({title:n,labelHeader:l,range:r,endpoint:i,emptyLabel:o,labelFallback:_})=>{const[g,u]=(0,t.useState)(1),[p,b]=(0,t.useState)(10),[E,w]=(0,t.useState)("hits"),[v,y]=(0,t.useState)("desc");(0,t.useEffect)(()=>{u(1)},[r.start,r.end]);const{data:f,isLoading:N,error:k}=h(i,{...r,page:g,per_page:p,orderby:E,order:v},{namespace:m?.settings?.restNamespace}),S=f?.items||[],C=f?.pagination||{},L=C.totalPages||1,x=C.totalItems||S.length;(0,t.useEffect)(()=>{!N&&!k&&L&&g>L&&u(L)},[L,g,N,k]);const D=g>1,B=g<L,A="asc"===v?(0,a.__)("Ascending","lean-stats"):(0,a.__)("Descending","lean-stats"),P=(0,a.sprintf)((0,a.__)("%s label","lean-stats"),l),T=S.map((e,t)=>({key:`${e.label||_}-${t}`,label:e.label||_,hits:e.hits}));return(0,e.createElement)(d,{title:n},(0,e.createElement)("div",{className:"ls-table-controls"},(0,e.createElement)(s.SelectControl,{label:(0,a.__)("Sort by","lean-stats"),value:E,options:[{label:(0,a.__)("Pageviews (hits)","lean-stats"),value:"hits"},{label:P,value:"label"}],onChange:e=>{w(e),u(1)},__nextHasNoMarginBottom:!0}),(0,e.createElement)(s.Button,{variant:"secondary",icon:"asc"===v?"arrow-up-alt2":"arrow-down-alt2",onClick:()=>{y("asc"===v?"desc":"asc"),u(1)}},A),(0,e.createElement)(s.SelectControl,{label:(0,a.__)("Rows","lean-stats"),value:String(p),options:[{label:"5",value:"5"},{label:"10",value:"10"},{label:"20",value:"20"}],onChange:e=>{b(Number(e)),u(1)},__nextHasNoMarginBottom:!0})),(0,e.createElement)(c,{isLoading:N,error:k,isEmpty:!N&&!k&&0===T.length,emptyLabel:o,loadingLabel:(0,a.sprintf)((0,a.__)("Loading: %s","lean-stats"),n)}),!N&&!k&&T.length>0&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("table",{className:"widefat striped ls-report-table","aria-label":n},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",null,l),(0,e.createElement)("th",null,(0,a.__)("Pageviews (hits)","lean-stats")))),(0,e.createElement)("tbody",null,T.map(t=>(0,e.createElement)("tr",{key:t.key},(0,e.createElement)("td",null,t.label),(0,e.createElement)("td",null,t.hits))))),(0,e.createElement)(s.Flex,{className:"ls-table-pagination",justify:"space-between",align:"center"},(0,e.createElement)(s.FlexItem,null,(0,e.createElement)(s.ButtonGroup,null,(0,e.createElement)(s.Button,{variant:"secondary",onClick:()=>u(e=>Math.max(e-1,1)),disabled:!D},(0,a.__)("Previous","lean-stats")),(0,e.createElement)(s.Button,{variant:"secondary",onClick:()=>u(e=>Math.min(e+1,L)),disabled:!B},(0,a.__)("Next","lean-stats")))),(0,e.createElement)(s.FlexItem,{className:"ls-table-pagination__meta"},(0,a.sprintf)((0,a.__)("Page %1$d of %2$d","lean-stats"),g,L)),(0,e.createElement)(s.FlexItem,{className:"ls-table-pagination__meta"},(0,a.sprintf)((0,a.__)("%s items","lean-stats"),x)))))},S=({range:t})=>{const{data:s,isLoading:n,error:l}=h("/admin/device-split",t),r=(s?.items||[]).map(e=>({...e,label:e.label?e.label.charAt(0).toUpperCase()+e.label.slice(1):(0,a.__)("Unknown","lean-stats")})),i=r.reduce((e,t)=>Math.max(e,t.hits),0);return(0,e.createElement)(d,{title:(0,a.__)("Device hits (pageviews)","lean-stats")},(0,e.createElement)(c,{isLoading:n,error:l,isEmpty:!n&&!l&&0===r.length,emptyLabel:(0,a.__)("No device data available.","lean-stats"),loadingLabel:(0,a.__)("Loading device breakdown…","lean-stats")}),!n&&!l&&r.length>0&&(0,e.createElement)("div",{className:"ls-device-breakdown"},r.map(t=>{const s=i?Math.round(t.hits/i*100):0;return(0,e.createElement)("div",{key:t.label,className:"ls-device-breakdown__row"},(0,e.createElement)("div",{className:"ls-device-breakdown__label"},t.label),(0,e.createElement)("div",{className:"ls-device-breakdown__bar","aria-hidden":"true"},(0,e.createElement)("div",{className:"ls-device-breakdown__bar-fill",style:{width:`${s}%`}})),(0,e.createElement)("div",{className:"ls-device-breakdown__value"},(0,a.sprintf)((0,a.__)("%s hits","lean-stats"),t.hits)))})))},C=()=>{const[s,n]=(0,t.useState)("30d"),l=(0,t.useMemo)(()=>(e=>{const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(a);switch(e){case"7d":s.setDate(s.getDate()-6);break;case"30d":default:s.setDate(s.getDate()-29);break;case"90d":s.setDate(s.getDate()-89)}return{start:p(s),end:p(a)}})(s),[s]);return(0,e.createElement)("div",{className:"ls-overview"},(0,e.createElement)("div",{className:"ls-overview__summary"},(0,e.createElement)(v,{value:s,onChange:n}),(0,e.createElement)(f,{range:l})),(0,e.createElement)(N,{range:l}),(0,e.createElement)("div",{className:"ls-overview__grid"},(0,e.createElement)(k,{title:(0,a.__)("Top pages","lean-stats"),labelHeader:(0,a.__)("Page","lean-stats"),range:l,endpoint:"/top-pages",emptyLabel:(0,a.__)("No popular pages available.","lean-stats"),labelFallback:"/"}),(0,e.createElement)(k,{title:(0,a.__)("Top referrers","lean-stats"),labelHeader:(0,a.__)("Referrer","lean-stats"),range:l,endpoint:"/referrers",emptyLabel:(0,a.__)("No referrers available.","lean-stats"),labelFallback:(0,a.__)("Direct","lean-stats")}),(0,e.createElement)(S,{range:l})))},L=document.getElementById("lean-stats-admin");L&&(0,t.render)((0,e.createElement)(()=>{var i;if(!m)return(0,e.createElement)(s.Notice,{status:"error",isDismissible:!1},(0,a.__)("Missing admin configuration.","lean-stats"));const o=(e=>{if(!Array.isArray(e))return g;const t=e.map(e=>({name:e?.name||"",title:e?.title||e?.name||""})).filter(e=>e.name);return t.length>0?t:g})(m?.panels),c=m?.currentPanel||"dashboard",d=(e=>{const t={dashboard:C,settings:y};return t[e]?t[e]:(window.LeanStatsAdminPanels||{})[e]||null})(c),_=((e,t)=>{const s=t.find(t=>t.name===e);return s?.title||(0,a.__)("Lean Stats","lean-stats")})(c,o),u=m?.settings?.pluginLabel||(0,a.__)("Lean Stats","lean-stats"),p=Boolean(null!==(i=window.LEAN_STATS_DEBUG)&&void 0!==i?i:m?.settings?.debugEnabled),b=(0,t.useMemo)(()=>r({debugEnabled:p}),[p]);return(0,t.useEffect)(()=>{(e=>{window&&window.addEventListener&&(window.addEventListener("error",t=>{e.error("Global error captured",{action:"window.error",message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,error:t.error?t.error.toString():void 0})}),window.addEventListener("unhandledrejection",t=>{e.error("Unhandled promise rejection",{action:"window.unhandledrejection",reason:t.reason?t.reason.toString():void 0})}))})(b),b.info("Loading admin interface",{action:"admin.init",traceId:n(),context:l()})},[b]),(0,e.createElement)("div",{className:"ls-admin-app"},(0,e.createElement)("h1",null,u),d?(0,e.createElement)(d,{panel:{name:c,title:_}}):(0,e.createElement)(s.Notice,{status:"warning",isDismissible:!1},(0,a.__)("No panel available for this screen.","lean-stats")))},null),L)})();