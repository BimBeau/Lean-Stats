(()=>{"use strict";const e=window.React,a=window.wp.element,t=window.wp.i18n,n=window.wp.components;class l extends a.Component{state={error:null};static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,a){const{onError:t}=this.props;t&&t(e,a)}render(){const{error:a}=this.state,{fatal:l,checkedHandles:s=[],checkedGlobals:r=[],children:i}=this.props,o=l||a;if(o){const a=(o?.checkedHandles||s).filter(Boolean),l=(o?.checkedGlobals||r).filter(Boolean),i=o?.reason||o?.message||("string"==typeof o?o:"");return(0,e.createElement)(n.Notice,{status:"error",isDismissible:!1},(0,e.createElement)("p",null,(0,t.__)("Lean Stats cannot load the admin interface.","lean-stats")),i&&(0,e.createElement)("p",null,i),a.length>0&&(0,e.createElement)("p",null,(0,t.sprintf)((0,t.__)("Script handles checked: %s","lean-stats"),a.join(", "))),l.length>0&&(0,e.createElement)("p",null,(0,t.sprintf)((0,t.__)("Global namespaces checked: %s","lean-stats"),l.join(", "))))}return i}}const s=l,r=window.LeanStatsAdmin||null,i=[{name:"dashboard",title:(0,t.__)("Dashboard","lean-stats")},{name:"top-pages",title:(0,t.__)("Pages","lean-stats")},{name:"referrers",title:(0,t.__)("Referring sites","lean-stats")},{name:"search-terms",title:(0,t.__)("Internal searches","lean-stats")},{name:"geolocation",title:(0,t.__)("Geolocation","lean-stats")},{name:"settings",title:(0,t.__)("Settings","lean-stats")}],o={plugin_label:"",respect_dnt_gpc:!0,url_strip_query:!0,url_query_allowlist:[],raw_logs_enabled:!1,raw_logs_retention_days:1,excluded_roles:[],excluded_paths:[],debug_enabled:!1,geo_aggregation_enabled:!0,maxmind_account_id:"",maxmind_license_key:""},c=["7d","30d","90d"],d=[{label:(0,t.__)("7 days","lean-stats"),value:"7d"},{label:(0,t.__)("30 days","lean-stats"),value:"30d"},{label:(0,t.__)("90 days","lean-stats"),value:"90d"}],m=["url","title"],u=()=>`ls-${Math.random().toString(36).slice(2,8)}${Date.now().toString(36).slice(-4)}`,_=()=>{const e=Boolean(window?.chrome&&window.chrome.runtime);return{userAgent:"undefined"==typeof navigator?"":navigator.userAgent||"",hasChromeRuntime:e,suggestion:"Test in private browsing to isolate extensions."}},g=({debugEnabled:e=!1,prefix:a="[LeanStats]"}={})=>{const t=()=>"function"==typeof e?e():e,n=(e,n,l,s=!1)=>{(s||t())&&((e,t,n)=>{const l=`${a} ${t}`;console&&console.groupCollapsed?(console.groupCollapsed(l),console[e](n),console.groupEnd()):console[e](l,n)})(e,n,{time:"undefined"!=typeof performance&&performance.now?Number(performance.now().toFixed(2)):Date.now(),page:"undefined"!=typeof window&&window.location&&window.location.pathname||"",...l})};return{debug:(e,a={})=>n("debug",e,a),info:(e,a={})=>n("info",e,a),warn:(e,a={})=>n("warn",e,a),error:(e,l={})=>{t()?n("error",e,l,!0):console&&console.error&&console.error(`${a} ${e}`)},isDebugEnabled:()=>e}},p=e=>c.includes(e)?e:null,b=e=>m.includes(e)?e:null,h=()=>`lean_stats_range_preset:${r?.currentUserId?String(r.currentUserId):"default"}`,E=()=>`lean_stats_page_label_display:${r?.currentUserId?String(r.currentUserId):"default"}`,y=()=>{const e=(()=>{if("undefined"==typeof window)return null;const e=new URLSearchParams(window.location.search);return p(e.get("period")||e.get("range"))})(),[t,n]=(0,a.useState)(()=>e||(()=>{if("undefined"==typeof window||!window.localStorage)return null;try{return p(window.localStorage.getItem(h()))}catch(e){return null}})()||"30d"),[l,s]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{e&&!l||Boolean(p(t))&&(e=>{if("undefined"!=typeof window&&window.localStorage)try{window.localStorage.setItem(h(),e)}catch(e){}})(t)},[t,e,l]),[t,e=>{n(e),s(!0)}]},v=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,w=e=>{const a=new Date,t=new Date(a.getFullYear(),a.getMonth(),a.getDate()),n=new Date(t);switch(e){case"7d":n.setDate(n.getDate()-6);break;case"30d":default:n.setDate(n.getDate()-29);break;case"90d":n.setDate(n.getDate()-89)}return{start:v(n),end:v(t)}},f=({value:a,onChange:l})=>(0,e.createElement)(n.Card,{className:"ls-overview__summary-card ls-overview__summary-card--filter"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)(n.SelectControl,{label:(0,t.__)("Period","lean-stats"),value:a,options:d,onChange:l,__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}))),N=()=>{var e;return Boolean(null!==(e=window.LEAN_STATS_DEBUG)&&void 0!==e?e:r?.settings?.debugEnabled)},S=(e,a,t)=>{const n=r?.restUrl?`${r.restUrl}`:"",l=new URL(`${null!=t?t:r?.settings?.restInternalNamespace||""}${e}`,n);return a&&Object.entries(a).forEach(([e,a])=>{null!=a&&""!==a&&l.searchParams.set(e,a)}),l.toString()},C=(e,n,l={})=>{const[s,i]=(0,a.useState)(null),[o,c]=(0,a.useState)(!0),[d,m]=(0,a.useState)(null),_=(0,a.useMemo)(()=>JSON.stringify(null!=n?n:{}),[n]),p=(0,a.useMemo)(()=>g({debugEnabled:N}),[]),{enabled:b=!0,namespace:h=r?.settings?.restInternalNamespace}=l;return(0,a.useEffect)(()=>{if(!b||!e)return c(!1),m(null),void i(null);let a=!0;const l=new AbortController,s=u();return(async()=>{if(!r?.restNonce||!r?.restUrl)return m((0,t.__)("Missing REST configuration.","lean-stats")),void c(!1);c(!0),m(null),p.debug("Loading admin data",{action:"admin.fetch",traceId:s,path:e,params:n});try{const o=await fetch(S(e,n,h),{signal:l.signal,headers:{"X-WP-Nonce":r.restNonce}});if(!o.ok)throw new Error((0,t.sprintf)((0,t.__)("API error (%s)","lean-stats"),o.status));const c=await o.json();a&&i(c),p.debug("Admin data received",{action:"admin.fetch.success",traceId:s,path:e})}catch(n){a&&"AbortError"!==n.name?(m(n.message||(0,t.__)("Loading error.","lean-stats")),p.error("Admin load error",{action:"admin.fetch.error",traceId:s,path:e,error:n?.message})):"AbortError"===n.name&&p.debug("Admin load cancelled",{action:"admin.fetch.abort",traceId:s,path:e})}finally{a&&c(!1)}})(),()=>{a=!1,l.abort()}},[e,_,b]),{data:s,isLoading:o,error:d}},x=["ls-skeleton__bar--w80","ls-skeleton__bar--w74","ls-skeleton__bar--w68","ls-skeleton__bar--w62","ls-skeleton__bar--w56","ls-skeleton__bar--w50"],k=({isLoading:a,error:l,isEmpty:s,emptyLabel:r,loadingLabel:i=(0,t.__)("Loading…","lean-stats"),skeletonRows:o=4})=>{if(a){const a=Array.from({length:o},(e,a)=>a);return(0,e.createElement)("div",{className:"ls-data-state","aria-live":"polite","aria-busy":"true"},(0,e.createElement)("div",{className:"ls-data-state__header"},(0,e.createElement)(n.Spinner,null),(0,e.createElement)("span",null,i)),(0,e.createElement)("div",{className:"ls-skeleton"},a.map(a=>(0,e.createElement)("div",{key:a,className:`ls-skeleton__bar ${x[Math.min(a,x.length-1)]}`}))))}return l?(0,e.createElement)(n.Notice,{status:"error",isDismissible:!1},l):s?(0,e.createElement)("p",{role:"status"},r):null},L=({className:e,children:t})=>(0,a.createElement)("div",{className:e},t),M=({title:e,children:t,...l})=>{const s=n.Card||L,r=n.CardHeader||L,i=n.CardBody||L,o={className:["ls-card",l.className].filter(Boolean).join(" ")},c=n.Card?l:o;return(0,a.createElement)(s,c,e?(0,a.createElement)(r,n.CardHeader?void 0:{className:"ls-card__header"},(0,a.createElement)("strong",null,e)):null,(0,a.createElement)(i,n.CardBody?void 0:{className:"ls-card__body"},t))},T=({title:l,labelHeader:s,range:i,endpoint:o,emptyLabel:c,labelFallback:d,formatLabel:m,metricLabel:u=(0,t.__)("Page views","lean-stats"),metricKey:_="hits",metricValueKey:g="hits",supportsPageLabelToggle:p=!1})=>{const[h,y]=(0,a.useState)(1),[v,w]=(0,a.useState)(10),[f,N]=(0,a.useState)(_),[S,x]=(0,a.useState)("desc"),[L,T]=(()=>{const[e,t]=(0,a.useState)(()=>(()=>{if("undefined"==typeof window||!window.localStorage)return null;try{return b(window.localStorage.getItem(E()))}catch(e){return null}})()||"url");return(0,a.useEffect)(()=>{Boolean(b(e))&&(e=>{if("undefined"!=typeof window&&window.localStorage)try{window.localStorage.setItem(E(),e)}catch(e){}})(e)},[e]),[e,t]})(),B=p&&"title"===L?(0,t.__)("Title","lean-stats"):s,$=p&&"title"===L?"page_title":"label";(0,a.useEffect)(()=>{y(1)},[i.start,i.end]),(0,a.useEffect)(()=>{N(_),x("desc")},[_]),(0,a.useEffect)(()=>{p&&"label"===f&&"page_title"===$&&(N("page_title"),y(1)),p&&"page_title"===f&&"label"===$&&(N("label"),y(1))},[p,f,$]);const{data:P,isLoading:A,error:I}=C(o,{...i,page:h,per_page:v,orderby:f,order:S},{namespace:r?.settings?.restNamespace}),D=P?.items||[],R=P?.pagination||{},G=R.totalPages||1,F=R.totalItems||D.length;(0,a.useEffect)(()=>{!A&&!I&&G&&h>G&&y(G)},[G,h,A,I]);const U=h>1,H=h<G,K="asc"===S?(0,t.__)("Ascending","lean-stats"):(0,t.__)("Descending","lean-stats"),q=`${B} ${(0,t.__)("label","lean-stats")}`
/* translators: %s: current sort order label. */,O=`${(0,t.__)("Toggle sort order","lean-stats")}: ${K}`
/* translators: %s: table title. */,V=`${(0,t.__)("Table","lean-stats")}: ${l}`,j=D.map((e,a)=>{var t;const n=e.label||"",l=(m?m(n,e):n)||d;return{key:`${l}-${a}`,label:l,pageTitle:e.page_title||"",value:null!==(t=e?.[g])&&void 0!==t?t:0}});return(0,e.createElement)(M,{title:l},(0,e.createElement)("div",{className:"ls-table-controls"},(0,e.createElement)(n.SelectControl,{label:(0,t.__)("Sort by","lean-stats"),value:f,options:[{label:u,value:_},{label:q,value:$}],onChange:e=>{N(e),y(1)},__nextHasNoMarginBottom:!0}),p&&(0,e.createElement)(n.SelectControl,{label:(0,t.__)("Display","lean-stats"),value:L,options:[{label:(0,t.__)("URL","lean-stats"),value:"url"},{label:(0,t.__)("Title","lean-stats"),value:"title"}],onChange:e=>{const a=b(e)||"url";T(a),N("title"===a?"page_title":"label"),y(1)},__nextHasNoMarginBottom:!0}),(0,e.createElement)(n.Button,{variant:"secondary",icon:"asc"===S?"arrow-up-alt2":"arrow-down-alt2",onClick:()=>{x("asc"===S?"desc":"asc"),y(1)},"aria-label":O},K),(0,e.createElement)(n.SelectControl,{label:(0,t.__)("Rows","lean-stats"),value:String(v),options:[{label:"5",value:"5"},{label:"10",value:"10"},{label:"20",value:"20"}],onChange:e=>{w(Number(e)),y(1)},__nextHasNoMarginBottom:!0})),(0,e.createElement)(k,{isLoading:A,error:I,isEmpty:!A&&!I&&0===j.length,emptyLabel:c,loadingLabel:`${(0,t.__)("Loading","lean-stats")}: ${l}`}),!A&&!I&&j.length>0&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("table",{className:"widefat striped ls-report-table","aria-label":V},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",{scope:"col"},B),(0,e.createElement)("th",{scope:"col"},u))),(0,e.createElement)("tbody",null,j.map(a=>(0,e.createElement)("tr",{key:a.key},(0,e.createElement)("td",null,p&&"title"===L?(e=>"string"!=typeof e?"":e.length>40?`${e.slice(0,40)}...`:e)(a.pageTitle||a.label):a.label),(0,e.createElement)("td",null,a.value))))),(0,e.createElement)(n.Flex,{className:"ls-table-pagination",justify:"space-between",align:"center"},(0,e.createElement)(n.FlexItem,null,(0,e.createElement)(n.ButtonGroup,null,(0,e.createElement)(n.Button,{variant:"secondary",onClick:()=>y(e=>Math.max(e-1,1)),disabled:!U,"aria-label":(0,t.__)("Previous page","lean-stats")},(0,t.__)("Previous","lean-stats")),(0,e.createElement)(n.Button,{variant:"secondary",onClick:()=>y(e=>Math.min(e+1,G)),disabled:!H,"aria-label":(0,t.__)("Next page","lean-stats")},(0,t.__)("Next","lean-stats")))),(0,e.createElement)(n.FlexItem,{className:"ls-table-pagination__meta"},`${(0,t.__)("Page","lean-stats")} ${h} ${(0,t.__)("of","lean-stats")} ${G}`),(0,e.createElement)(n.FlexItem,{className:"ls-table-pagination__meta"},`${F} ${(0,t.__)("items","lean-stats")}`))))},B=({title:t,endpoint:n,labelHeader:l,emptyLabel:s,labelFallback:r,formatLabel:i,metricLabel:o,metricKey:c,metricValueKey:d,supportsPageLabelToggle:m=!1})=>{const[u,_]=y(),g=(0,a.useMemo)(()=>w(u),[u]);return(0,e.createElement)("div",{className:"ls-report-panel"},(0,e.createElement)("div",{className:"ls-report-panel__header"},(0,e.createElement)(f,{value:u,onChange:_})),(0,e.createElement)(T,{title:t,labelHeader:l,range:g,endpoint:n,emptyLabel:s,labelFallback:r,formatLabel:i,metricLabel:o,metricKey:c,metricValueKey:d,supportsPageLabelToggle:m}))},$=JSON.parse('{"AF":"Afghanistan","ZA":"Afrique du Sud","AL":"Albanie","DZ":"Algérie","DE":"Allemagne","AD":"Andorre","AO":"Angola","AI":"Anguilla","AQ":"Antarctique","AG":"Antigua-et-Barbuda","SA":"Arabie saoudite","AR":"Argentine","AM":"Arménie","AW":"Aruba","AU":"Australie","AT":"Autriche","AZ":"Azerbaïdjan","BS":"Bahamas","BH":"Bahreïn","BD":"Bangladesh","BB":"Barbade","BE":"Belgique","BZ":"Belize","BJ":"Bénin","BM":"Bermudes","BT":"Bhoutan","BY":"Biélorussie","BO":"Bolivie","BA":"Bosnie-Herzégovine","BW":"Botswana","BR":"Brésil","BN":"Brunéi Darussalam","BG":"Bulgarie","BF":"Burkina Faso","BI":"Burundi","KH":"Cambodge","CM":"Cameroun","CA":"Canada","CV":"Cap-Vert","CL":"Chili","CN":"Chine","CY":"Chypre","CO":"Colombie","KM":"Comores","CG":"Congo-Brazzaville","CD":"Congo-Kinshasa","KP":"Corée du Nord","KR":"Corée du Sud","CR":"Costa Rica","CI":"Côte d’Ivoire","HR":"Croatie","CU":"Cuba","CW":"Curaçao","DK":"Danemark","DJ":"Djibouti","DM":"Dominique","EG":"Égypte","AE":"Émirats arabes unis","EC":"Équateur","ER":"Érythrée","ES":"Espagne","EE":"Estonie","SZ":"Eswatini","VA":"État de la Cité du Vatican","FM":"États fédérés de Micronésie","US":"États-Unis","ET":"Éthiopie","FJ":"Fidji","FI":"Finlande","FR":"France","GA":"Gabon","GM":"Gambie","GE":"Géorgie","GS":"Géorgie du Sud et îles Sandwich du Sud","GH":"Ghana","GI":"Gibraltar","GR":"Grèce","GD":"Grenade","GL":"Groenland","GP":"Guadeloupe","GU":"Guam","GT":"Guatemala","GG":"Guernesey","GN":"Guinée","GQ":"Guinée équatoriale","GW":"Guinée-Bissau","GY":"Guyana","GF":"Guyane française","HT":"Haïti","HN":"Honduras","HU":"Hongrie","BV":"Île Bouvet","CX":"Île Christmas","IM":"Île de Man","NF":"Île Norfolk","AX":"Îles Åland","KY":"Îles Caïmans","CC":"Îles Cocos","CK":"Îles Cook","FO":"Îles Féroé","HM":"Îles Heard et McDonald","FK":"Îles Malouines","MP":"Îles Mariannes du Nord","MH":"Îles Marshall","UM":"Îles mineures éloignées des États-Unis","PN":"Îles Pitcairn","SB":"Îles Salomon","TC":"Îles Turques-et-Caïques","VG":"Îles Vierges britanniques","VI":"Îles Vierges des États-Unis","IN":"Inde","ID":"Indonésie","IQ":"Irak","IR":"Iran","IE":"Irlande","IS":"Islande","IL":"Israël","IT":"Italie","JM":"Jamaïque","JP":"Japon","JE":"Jersey","JO":"Jordanie","KZ":"Kazakhstan","KE":"Kenya","KG":"Kirghizistan","KI":"Kiribati","KW":"Koweït","RE":"La Réunion","LA":"Laos","LS":"Lesotho","LV":"Lettonie","LB":"Liban","LR":"Libéria","LY":"Libye","LI":"Liechtenstein","LT":"Lituanie","LU":"Luxembourg","MK":"Macédoine du Nord","MG":"Madagascar","MY":"Malaisie","MW":"Malawi","MV":"Maldives","ML":"Mali","MT":"Malte","MA":"Maroc","MQ":"Martinique","MU":"Maurice","MR":"Mauritanie","YT":"Mayotte","MX":"Mexique","MD":"Moldavie","MC":"Monaco","MN":"Mongolie","ME":"Monténégro","MS":"Montserrat","MZ":"Mozambique","MM":"Myanmar (Birmanie)","NA":"Namibie","NR":"Nauru","NP":"Népal","NI":"Nicaragua","NE":"Niger","NG":"Nigéria","NU":"Niue","NO":"Norvège","NC":"Nouvelle-Calédonie","NZ":"Nouvelle-Zélande","OM":"Oman","UG":"Ouganda","UZ":"Ouzbékistan","PK":"Pakistan","PW":"Palaos","PA":"Panama","PG":"Papouasie-Nouvelle-Guinée","PY":"Paraguay","NL":"Pays-Bas","BQ":"Pays-Bas caribéens","PE":"Pérou","PH":"Philippines","PL":"Pologne","PF":"Polynésie française","PR":"Porto Rico","PT":"Portugal","QA":"Qatar","HK":"R.A.S. chinoise de Hong Kong","MO":"R.A.S. chinoise de Macao","CF":"République centrafricaine","DO":"République dominicaine","RO":"Roumanie","GB":"Royaume-Uni","RU":"Russie","RW":"Rwanda","EH":"Sahara occidental","BL":"Saint-Barthélemy","KN":"Saint-Christophe-et-Niévès","SM":"Saint-Marin","MF":"Saint-Martin","SX":"Saint-Martin (partie néerlandaise)","PM":"Saint-Pierre-et-Miquelon","VC":"Saint-Vincent-et-les-Grenadines","SH":"Sainte-Hélène","LC":"Sainte-Lucie","SV":"Salvador","WS":"Samoa","AS":"Samoa américaines","ST":"Sao Tomé-et-Principe","SN":"Sénégal","RS":"Serbie","SC":"Seychelles","SL":"Sierra Leone","SG":"Singapour","SK":"Slovaquie","SI":"Slovénie","SO":"Somalie","SD":"Soudan","SS":"Soudan du Sud","LK":"Sri Lanka","SE":"Suède","CH":"Suisse","SR":"Suriname","SJ":"Svalbard et Jan Mayen","SY":"Syrie","TJ":"Tadjikistan","TW":"Taïwan","TZ":"Tanzanie","TD":"Tchad","CZ":"Tchéquie","TF":"Terres australes françaises","IO":"Territoire britannique de l’océan Indien","PS":"Territoires palestiniens","TH":"Thaïlande","TL":"Timor oriental","TG":"Togo","TK":"Tokelau","TO":"Tonga","TT":"Trinité-et-Tobago","TN":"Tunisie","TM":"Turkménistan","TR":"Turquie","TV":"Tuvalu","UA":"Ukraine","UY":"Uruguay","VU":"Vanuatu","VE":"Venezuela","VN":"Vietnam","WF":"Wallis-et-Futuna","YE":"Yémen","ZM":"Zambie","ZW":"Zimbabwe"}'),P=new Set(["","XX","UNKNOWN"]),A=e=>{const a="string"==typeof e?e.trim().toUpperCase():"";if(!a||P.has(a))return(0,t.__)("Unknown country","lean-stats");const n="undefined"!=typeof document&&document.documentElement?.lang?document.documentElement.lang:"undefined"!=typeof navigator&&navigator.language?navigator.language:"en",l=(e=>{if("undefined"==typeof Intl||"function"!=typeof Intl.DisplayNames)return null;try{return new Intl.DisplayNames([e],{type:"region"})}catch(e){return null}})(n);if(l){const e=l.of(a);if(e&&e!==a)return e}return n.toLowerCase().startsWith("fr")?$[a]||(0,t.__)("Unknown country","lean-stats"):a},I=()=>{const a=[{name:"countries",title:(0,t.__)("Top countries","lean-stats")},{name:"cities",title:(0,t.__)("Top cities","lean-stats")}];return(0,e.createElement)(n.TabPanel,{className:"ls-geolocation-tabs",tabs:a},a=>"countries"===a.name?(0,e.createElement)(B,{title:(0,t.__)("Top countries","lean-stats"),labelHeader:(0,t.__)("Country","lean-stats"),endpoint:"/geo-countries",emptyLabel:(0,t.__)("No country data available.","lean-stats"),labelFallback:(0,t.__)("Unknown country","lean-stats"),formatLabel:A}):"cities"===a.name?(0,e.createElement)(B,{title:(0,t.__)("Top cities","lean-stats"),labelHeader:(0,t.__)("City","lean-stats"),endpoint:"/geo-cities",emptyLabel:(0,t.__)("No city data available.","lean-stats"),labelFallback:(0,t.__)("Unknown","lean-stats")}):null)},D=({range:a})=>{const{data:n,isLoading:l,error:s}=C("/admin/device-split",a),r=(n?.items||[]).map(e=>{const a="desktop"===(e.label?e.label.toLowerCase():"")?(0,t.__)("Desktop","lean-stats"):null;return{...e,label:a||(e.label?e.label.charAt(0).toUpperCase()+e.label.slice(1):(0,t.__)("Unknown","lean-stats"))}}),i=r.reduce((e,a)=>Math.max(e,a.hits),0);return(0,e.createElement)(M,{title:(0,t.__)("Device page views","lean-stats")},(0,e.createElement)(k,{isLoading:l,error:s,isEmpty:!l&&!s&&0===r.length,emptyLabel:(0,t.__)("No device data available.","lean-stats"),loadingLabel:(0,t.__)("Loading device breakdown…","lean-stats")}),!l&&!s&&r.length>0&&(0,e.createElement)("div",{className:"ls-device-breakdown"},r.map(a=>{const n=i?Math.round(a.hits/i*100):0;return(0,e.createElement)("div",{key:a.label,className:"ls-device-breakdown__row"},(0,e.createElement)("div",{className:"ls-device-breakdown__label"},a.label),(0,e.createElement)("div",{className:"ls-device-breakdown__bar","aria-hidden":"true"},(0,e.createElement)("div",{className:"ls-device-breakdown__bar-fill",style:{width:`${n}%`}})),(0,e.createElement)("div",{className:"ls-device-breakdown__value"},`${a.hits} ${(0,t._n)("view","views",a.hits,"lean-stats")}`))})))},R=({children:a,status:t="info"})=>(0,e.createElement)("span",{className:`ls-kpi-card__badge ls-kpi-card__badge--${t}`,role:"status"},a),G=({range:a})=>{const{data:l,isLoading:s,error:i}=C("/overview",a,{namespace:r?.settings?.restNamespace}),o=l?.overview||null,c=l?.comparison?.overview||null,d=!s&&!i&&!o;if(s){const a=[{icon:"visibility"},{icon:"chart-bar"},{icon:"admin-links"},{icon:"warning"},{icon:"search"}];return(0,e.createElement)(e.Fragment,null,a.map((a,l)=>(0,e.createElement)(n.Card,{key:`loading-${a.icon}-${l}`,className:"ls-overview__summary-card"},(0,e.createElement)(n.CardBody,{className:"ls-kpi-card__body ls-kpi-card__body--loading"},(0,e.createElement)("div",{className:"ls-kpi-card__content"},(0,e.createElement)("p",{className:"ls-kpi-card__label ls-kpi-card__label--loading"},(0,e.createElement)(n.Spinner,null),(0,e.createElement)("span",null,(0,t.__)("Loading…","lean-stats"))),(0,e.createElement)("span",{className:"ls-kpi-card__value-skeleton","aria-hidden":"true"})),(0,e.createElement)("span",{className:`dashicons dashicons-${a.icon} ls-kpi-card__icon`,"aria-hidden":"true"})))))}if(i||d)return(0,e.createElement)(n.Card,{className:"ls-overview__summary-card ls-overview__summary-card--status"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)(k,{isLoading:s,error:i,isEmpty:d,emptyLabel:(0,t.__)("No overview metrics available.","lean-stats"),loadingLabel:(0,t.__)("Loading KPIs…","lean-stats"),skeletonRows:3})));const m=[{key:"visits",label:(0,t.__)("Visits","lean-stats"),value:o.visits,icon:"visibility",comparison:c?.visits},{key:"pageViews",label:(0,t.__)("Page views","lean-stats"),value:o.pageViews,icon:"chart-bar",comparison:c?.pageViews},{key:"uniqueReferrers",label:(0,t.__)("Referring sites","lean-stats"),value:o.uniqueReferrers,icon:"admin-links",comparison:c?.uniqueReferrers},{key:"notFoundHits",label:(0,t.__)("Pages not found (404)","lean-stats"),value:o.notFoundHits,icon:"warning",comparison:c?.notFoundHits},{key:"searchHits",label:(0,t.__)("Internal searches","lean-stats"),value:o.searchHits,icon:"search",comparison:c?.searchHits}];return(0,e.createElement)(e.Fragment,null,m.map(a=>{const t=Number(a.value)||0,l=(s=t,null==(r=null===a.comparison||void 0===a.comparison?null:Number(a.comparison))?null:0===r?0===s?0:100:(s-r)/r*100);var s,r;const i=(e=>{if(null==e)return null;const a=new Intl.NumberFormat(void 0,{maximumFractionDigits:1,minimumFractionDigits:0,signDisplay:"exceptZero"});return 0===e||Object.is(e,-0)?`${a.format(0)}%`:`${a.format(e)}%`})(l),o=l>0,c=l<0,d=0===l||Object.is(l,-0);return(0,e.createElement)(n.Card,{key:a.key,className:"ls-overview__summary-card"},(0,e.createElement)(n.CardBody,{className:"ls-kpi-card__body"},(0,e.createElement)("div",{className:"ls-kpi-card__content"},(0,e.createElement)("p",{className:"ls-kpi-card__label"},a.label),(0,e.createElement)("p",{className:"ls-kpi-card__value-row"},(0,e.createElement)("span",{className:"ls-kpi-card__value"},t),null!==i&&(0,e.createElement)(R,{status:o?"success":c?"error":d?"warning":"info"},i))),(0,e.createElement)("span",{className:`dashicons dashicons-${a.icon} ls-kpi-card__icon`,"aria-hidden":"true"})))}))},F=({height:t,ariaLabel:n,children:l,onResize:s})=>{const{ref:r,size:i,hasSize:o}=(()=>{const e=(0,a.useRef)(null),[t,n]=(0,a.useState)({width:0,height:0}),l=t.width>0&&t.height>0;return(0,a.useEffect)(()=>{const a=e.current;if(!a)return;const t=()=>{const e=a.getBoundingClientRect(),t={width:Math.round(e.width),height:Math.round(e.height)};n(e=>e.width===t.width&&e.height===t.height?e:t)};let l;return t(),window.ResizeObserver?(l=new ResizeObserver(()=>t()),l.observe(a)):window.addEventListener("resize",t),()=>{l?l.disconnect():window.removeEventListener("resize",t)}},[]),{ref:e,size:t,hasSize:l}})();return(0,a.useEffect)(()=>{o&&s&&s(i)},[o,s,i]),(0,e.createElement)("div",{ref:r,className:"ls-chart-frame","data-height":t,role:"img","aria-label":n},o?l:null)},U=({range:n})=>{var l;const{data:s,isLoading:r,error:i}=C("/admin/timeseries/day",n),o=null!==(l=s?.items)&&void 0!==l?l:[],[c,d]=(0,a.useState)(640),m=(0,a.useMemo)(()=>((e,a=640)=>{const t=e.reduce((e,a)=>Math.max(e,a.hits),0),n=Math.max(Math.round(a),65),l=Math.max(n-64,1),s=Math.max(176,1),r=Math.max(e.length-1,1),i=e.map((e,a)=>({x:32+l*a/r,y:208-(t?e.hits/t*s:0),label:e.bucket,hits:e.hits})),o=((e,a=.2)=>{if(0===e.length)return"";const t=(e,t,n,l=!1)=>{const s=t||e,r=n||e,i=Math.hypot(r.x-s.x,r.y-s.y),o=Math.atan2(r.y-s.y,r.x-s.x)+(l?Math.PI:0),c=i*a;return{x:e.x+Math.cos(o)*c,y:e.y+Math.sin(o)*c}};return e.reduce((e,a,n,l)=>{if(0===n)return`M ${a.x} ${a.y}`;const s=l[n-1],r=l[n+1],i=t(s,l[n-2],a),o=t(a,s,r,!0);return`${e} C ${i.x} ${i.y} ${o.x} ${o.y} ${a.x} ${a.y}`},"")})(i),c=i.length>0?`${o} L ${i[i.length-1].x} 208 L ${i[0].x} 208 Z`:"",d=Math.min(5,e.length),m=new Set;if(d<=1)m.add(0);else{const a=(e.length-1)/(d-1);for(let e=0;e<d;e+=1)m.add(Math.round(e*a))}const u=e.map((e,a)=>m.has(a)?{x:32+l*a/r,label:e.bucket}:null).filter(Boolean),_=Array.from({length:4},(e,a)=>{const n=a/3;return{y:32+s*n,value:Math.round(t*(1-n))}});return{points:i,linePath:o,areaPath:c,maxHits:t,width:n,height:240,padding:32,baselineY:208,xLabels:u,yTicks:_}})(o,c),[o,c]),[u,_]=(0,a.useState)(null),g=(0,a.useCallback)(({width:e})=>{const a=Math.max(Math.round(e),65);d(e=>e===a?e:a)},[]),p=e=>(new Intl.NumberFormat).format(e),b=e=>{const a=new Date(`${e}T00:00:00`);if(Number.isNaN(a.getTime()))return e;const t=(new Intl.DateTimeFormat).resolvedOptions().locale||"",n=/^en(?:-|$)/i.test(t);return new Intl.DateTimeFormat(n?"en-US":void 0,{day:"2-digit",month:"2-digit",year:"2-digit"}).format(a)},h=e=>`${p(e)} ${(0,t._n)("page view","page views",e,"lean-stats")}`,E=(0,a.useCallback)(e=>{if(!m.points.length)return;const a=e.currentTarget.getBoundingClientRect();if(!a.width)return;const t=(e.clientX-a.left)/a.width*m.width;let n=m.points[0],l=Math.abs(n.x-t);m.points.forEach(e=>{const a=Math.abs(e.x-t);a<l&&(n=e,l=a)}),_(e=>e?.label===n.label?e:n)},[m.points,m.width]),y=u?`${b(u.label)} : ${h(u.hits)}`:null,v="ls-timeseries-gradient";return(0,e.createElement)(M,{title:(0,t.__)("Daily page views","lean-stats")},(0,e.createElement)(k,{isLoading:r,error:i,isEmpty:!r&&!i&&0===o.length,emptyLabel:(0,t.__)("No data available for this period.","lean-stats"),loadingLabel:(0,t.__)("Loading chart…","lean-stats")}),!r&&!i&&o.length>0&&(0,e.createElement)("div",{className:"ls-timeseries"},(0,e.createElement)(F,{height:240,ariaLabel:(0,t.__)("Daily page views line chart","lean-stats"),onResize:g},(0,e.createElement)("div",{className:"ls-timeseries__chart",onMouseLeave:()=>_(null)},(0,e.createElement)("svg",{viewBox:`0 0 ${m.width} ${m.height}`,width:"100%",height:"100%",preserveAspectRatio:"xMidYMid meet",className:"ls-timeseries__svg",role:"img","aria-label":(0,t.__)("Daily page views line chart","lean-stats"),onMouseMove:E},(0,e.createElement)("defs",null,(0,e.createElement)("linearGradient",{id:v,x1:"0",y1:"0",x2:"0",y2:"1"},(0,e.createElement)("stop",{offset:"0%",stopColor:"var(--ls-text-2, #2271b1)",stopOpacity:"0.5"}),(0,e.createElement)("stop",{offset:"100%",stopColor:"var(--ls-text-2, #2271b1)",stopOpacity:"0"}))),(0,e.createElement)("rect",{x:"0",y:"0",width:m.width,height:m.height,className:"ls-timeseries__bg"}),m.yTicks.map(a=>(0,e.createElement)("g",{key:`tick-${a.value}-${a.y}`},(0,e.createElement)("line",{x1:m.padding,y1:a.y,x2:m.width-m.padding,y2:a.y,className:"ls-timeseries__grid-line"}),(0,e.createElement)("text",{x:m.padding-8,y:a.y+4,textAnchor:"end",className:"ls-timeseries__axis-label ls-timeseries__axis-label--y"},p(a.value)))),(0,e.createElement)("line",{x1:m.padding,y1:m.padding,x2:m.padding,y2:m.height-m.padding,className:"ls-timeseries__axis"}),(0,e.createElement)("line",{x1:m.padding,y1:m.height-m.padding,x2:m.width-m.padding,y2:m.height-m.padding,className:"ls-timeseries__axis"}),(0,e.createElement)("path",{d:m.areaPath,className:"ls-timeseries__area",fill:`url(#${v})`}),(0,e.createElement)("path",{d:m.linePath,className:"ls-timeseries__line"}),m.xLabels.map(a=>(0,e.createElement)("text",{key:`label-${a.label}`,x:a.x,y:m.height-m.padding+18,textAnchor:"middle",className:"ls-timeseries__axis-label"},(e=>{const a=new Date(`${e}T00:00:00`);return Number.isNaN(a.getTime())?e:new Intl.DateTimeFormat(void 0,{day:"2-digit",month:"short"}).format(a)})(a.label))),m.points.map(a=>(0,e.createElement)("circle",{key:`${a.label}-${a.hits}`,cx:a.x,cy:a.y,r:"4",className:"ls-timeseries__point"+(u?.label===a.label?" is-active":""),onMouseEnter:()=>_(a),onFocus:()=>_(a),onBlur:()=>_(null),tabIndex:"0"},(0,e.createElement)("title",null,`${b(a.label)} : ${h(a.hits)}`)))),u&&(0,e.createElement)("div",{key:`${u.label}-${u.hits}`,className:"ls-timeseries__tooltip",role:"status",style:{left:u.x/m.width*100+"%",top:`calc(${u.y/m.height*100}% - 3px)`}},y)))))},H=()=>{const[n,l]=y(),s=(0,a.useMemo)(()=>w(n),[n]);return(0,e.createElement)("div",{className:"ls-overview"},(0,e.createElement)("div",{className:"ls-overview__summary"},(0,e.createElement)(f,{value:n,onChange:l}),(0,e.createElement)(G,{range:s})),(0,e.createElement)(U,{range:s}),(0,e.createElement)("div",{className:"ls-overview__grid"},(0,e.createElement)(T,{title:(0,t.__)("Pages","lean-stats"),labelHeader:(0,t.__)("Url","lean-stats"),range:s,endpoint:"/top-pages",emptyLabel:(0,t.__)("No popular pages available.","lean-stats"),labelFallback:"/",supportsPageLabelToggle:!0}),(0,e.createElement)(T,{title:(0,t.__)("Top referrers","lean-stats"),labelHeader:(0,t.__)("Referrer","lean-stats"),range:s,endpoint:"/referrers",emptyLabel:(0,t.__)("No referrers available.","lean-stats"),labelFallback:(0,t.__)("Direct","lean-stats")}),(0,e.createElement)(D,{range:s})))},K=({range:l})=>{const[s,i]=(0,a.useState)(1),[o,c]=(0,a.useState)(10),[d,m]=(0,a.useState)("hits"),[u,_]=(0,a.useState)("desc");(0,a.useEffect)(()=>{i(1)},[l.start,l.end]);const{data:g,isLoading:p,error:b}=C("/referrer-sources",{...l,page:s,per_page:o,orderby:d,order:u},{namespace:r?.settings?.restNamespace}),h=g?.items||[],E=g?.pagination||{},y=E.totalPages||1,v=E.totalItems||h.length;(0,a.useEffect)(()=>{!p&&!b&&y&&s>y&&i(y)},[y,s,p,b]);const w=s>1,f=s<y,N="asc"===u?(0,t.__)("Ascending","lean-stats"):(0,t.__)("Descending","lean-stats"),S=`${(0,t.__)("Toggle sort order","lean-stats")}: ${N}`,x=(0,t.__)("Table: Referrer sources","lean-stats"),L=h.map((e,a)=>{const n=e.referrer_domain||(0,t.__)("Direct","lean-stats"),l=e.referrer_domain?(0,t.__)("Referrer","lean-stats"):(0,t.__)("Direct","lean-stats");return{key:`${n}-${e.source_category||l}-${a}`,referrer:n,category:e.source_category||l,hits:e.hits}});return(0,e.createElement)(M,{title:(0,t.__)("Referrer sources","lean-stats")},(0,e.createElement)("div",{className:"ls-table-controls"},(0,e.createElement)(n.SelectControl,{label:(0,t.__)("Sort by","lean-stats"),value:d,options:[{label:(0,t.__)("Page views","lean-stats"),value:"hits"},{label:(0,t.__)("Referrer","lean-stats"),value:"referrer"},{label:(0,t.__)("Source category","lean-stats"),value:"category"}],onChange:e=>{m(e),i(1)},__nextHasNoMarginBottom:!0}),(0,e.createElement)(n.Button,{variant:"secondary",icon:"asc"===u?"arrow-up-alt2":"arrow-down-alt2",onClick:()=>{_("asc"===u?"desc":"asc"),i(1)},"aria-label":S},N),(0,e.createElement)(n.SelectControl,{label:(0,t.__)("Rows","lean-stats"),value:String(o),options:[{label:"5",value:"5"},{label:"10",value:"10"},{label:"20",value:"20"}],onChange:e=>{c(Number(e)),i(1)},__nextHasNoMarginBottom:!0})),(0,e.createElement)(k,{isLoading:p,error:b,isEmpty:!p&&!b&&0===L.length,emptyLabel:(0,t.__)("No referrer data available.","lean-stats"),loadingLabel:(0,t.__)("Loading referrer sources…","lean-stats")}),!p&&!b&&L.length>0&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("table",{className:"widefat striped ls-report-table","aria-label":x},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",{scope:"col"},(0,t.__)("Referrer","lean-stats")),(0,e.createElement)("th",{scope:"col"},(0,t.__)("Source category","lean-stats")),(0,e.createElement)("th",{scope:"col"},(0,t.__)("Page views","lean-stats")))),(0,e.createElement)("tbody",null,L.map(a=>(0,e.createElement)("tr",{key:a.key},(0,e.createElement)("td",null,a.referrer),(0,e.createElement)("td",null,a.category),(0,e.createElement)("td",null,a.hits))))),(0,e.createElement)(n.Flex,{className:"ls-table-pagination",justify:"space-between",align:"center"},(0,e.createElement)(n.FlexItem,null,(0,e.createElement)(n.ButtonGroup,null,(0,e.createElement)(n.Button,{variant:"secondary",onClick:()=>i(e=>Math.max(e-1,1)),disabled:!w,"aria-label":(0,t.__)("Previous page","lean-stats")},(0,t.__)("Previous","lean-stats")),(0,e.createElement)(n.Button,{variant:"secondary",onClick:()=>i(e=>Math.min(e+1,y)),disabled:!f,"aria-label":(0,t.__)("Next page","lean-stats")},(0,t.__)("Next","lean-stats")))),(0,e.createElement)(n.FlexItem,{className:"ls-table-pagination__meta"},`${(0,t.__)("Page","lean-stats")} ${s} ${(0,t.__)("of","lean-stats")} ${y}`),(0,e.createElement)(n.FlexItem,{className:"ls-table-pagination__meta"},`${v} ${(0,t.__)("items","lean-stats")}`))))},q=()=>{const[t,n]=y(),l=(0,a.useMemo)(()=>w(t),[t]);return(0,e.createElement)("div",{className:"ls-report-panel"},(0,e.createElement)("div",{className:"ls-report-panel__header"},(0,e.createElement)(f,{value:t,onChange:n})),(0,e.createElement)(K,{range:l}))},O=()=>(0,e.createElement)(B,{title:(0,t.__)("Search terms","lean-stats"),labelHeader:(0,t.__)("Search term","lean-stats"),endpoint:"/search-terms",emptyLabel:(0,t.__)("No search terms available.","lean-stats"),labelFallback:(0,t.__)("Unknown","lean-stats")});var V;const j=Boolean(null!==(V=window.LEAN_STATS_DEBUG)&&void 0!==V?V:r?.settings?.debugEnabled),z=e=>{const a={...o,...e||{}},t=Boolean(a.debug_enabled||a.raw_logs_enabled);return{...a,debug_enabled:t,raw_logs_enabled:t}},W=({debugEnabled:a})=>{const{data:l,isLoading:s,error:r}=C("/admin/raw-logs",{limit:50},{enabled:a}),i=l?.items||[];return a?(0,e.createElement)("div",{className:"ls-settings-logs"},(0,e.createElement)(k,{isLoading:s,error:r,isEmpty:!s&&!r&&0===i.length,emptyLabel:(0,t.__)("No raw logs available.","lean-stats"),loadingLabel:(0,t.__)("Loading raw logs…","lean-stats"),skeletonRows:4}),!s&&!r&&i.length>0&&(0,e.createElement)("table",{className:"widefat striped ls-settings-logs__table"},(0,e.createElement)("thead",null,(0,e.createElement)("tr",null,(0,e.createElement)("th",null,(0,t.__)("Date","lean-stats")),(0,e.createElement)("th",null,(0,t.__)("Page","lean-stats")),(0,e.createElement)("th",null,(0,t.__)("Referrer","lean-stats")),(0,e.createElement)("th",null,(0,t.__)("Device","lean-stats")))),(0,e.createElement)("tbody",null,i.map((a,n)=>{return(0,e.createElement)("tr",{key:`${a.timestamp_bucket}-${n}`},(0,e.createElement)("td",null,(l=a.timestamp_bucket)?new Date(1e3*l).toLocaleString():""),(0,e.createElement)("td",null,a.page_path),(0,e.createElement)("td",null,a.referrer_domain||(0,t.__)("Direct","lean-stats")),(0,e.createElement)("td",null,a.device_class||"-"));var l})))):(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,t.__)("Enable debug mode to display raw logs.","lean-stats"))},Z=()=>{const{data:l,isLoading:s,error:i}=C("/admin/settings"),[c,d]=(0,a.useState)(o),[m,_]=(0,a.useState)(""),[p,b]=(0,a.useState)(""),[h,E]=(0,a.useState)(!1),[y,v]=(0,a.useState)(null),[w,f]=(0,a.useState)({}),[N,x]=(0,a.useState)(!1),[L,T]=(0,a.useState)(!1),[B,$]=(0,a.useState)(null),P=(0,a.useMemo)(()=>g({debugEnabled:j}),[]),A=Boolean(c.debug_enabled);(0,a.useEffect)(()=>{if(l?.settings){const e=z(l.settings);d(e),_(e.url_query_allowlist.join(", ")),b(e.excluded_paths.join("\n")),window.LEAN_STATS_DEBUG=Boolean(e.debug_enabled),f({})}},[l]);const I=async()=>{if(!r?.restNonce||!r?.restUrl)return void v({status:"error",message:(0,t.__)("Missing REST configuration.","lean-stats")});const e=(e=>{if(!e.geo_aggregation_enabled)return{};const a={},n=String(e.maxmind_account_id||"").trim(),l=String(e.maxmind_license_key||"").trim();return n?/^\d+$/.test(n)||(a.maxmind_account_id=(0,t.__)("MaxMind Account ID must be numeric.","lean-stats")):a.maxmind_account_id=(0,t.__)("MaxMind Account ID is required.","lean-stats"),l||(a.maxmind_license_key=(0,t.__)("MaxMind License Key is required.","lean-stats")),a})(c);if(Object.keys(e).length>0)return f(e),void v({status:"error",message:Object.values(e).join(" ")});E(!0),v(null);const a=u();P.info("Saving settings",{action:"settings.save",traceId:a});try{const e=await fetch(S("/admin/settings"),{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":r.restNonce},body:JSON.stringify(c)}),n=await e.json().catch(()=>null);if(!e.ok)throw n?.data?.field_errors&&f(n.data.field_errors),new Error(n?.message||`${(0,t.__)("API error","lean-stats")} (${e.status})`);if(n?.settings){const e=z(n.settings);d(e),_(e.url_query_allowlist.join(", ")),b(e.excluded_paths.join("\n")),window.LEAN_STATS_DEBUG=Boolean(e.debug_enabled),f({})}v({status:"success",message:(0,t.__)("Settings saved.","lean-stats")}),P.info("Settings saved",{action:"settings.save.success",traceId:a})}catch(e){v({status:"error",message:e.message||(0,t.__)("Error while saving.","lean-stats")}),P.error("Settings save error",{action:"settings.save.error",traceId:a,error:e?.message})}finally{E(!1)}},D=async()=>{if(!r?.restNonce||!r?.restUrl)return void $({status:"error",message:(0,t.__)("Missing REST configuration.","lean-stats")});T(!0),$(null);const e=u();P.info("Purging analytics data",{action:"settings.purge",traceId:e});try{const a=await fetch(S("/admin/purge-data"),{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":r.restNonce}});if(!a.ok)throw new Error(`${(0,t.__)("API error","lean-stats")} (${a.status})`);await a.json(),$({status:"success",message:(0,t.__)("Analytics data purged.","lean-stats")}),P.info("Analytics data purged",{action:"settings.purge.success",traceId:e})}catch(a){$({status:"error",message:a.message||(0,t.__)("Error while purging.","lean-stats")}),P.error("Purge error",{action:"settings.purge.error",traceId:e,error:a?.message})}finally{T(!1),x(!1)}},R=r?.roles||[],G=[{name:"general",title:(0,t.__)("General","lean-stats")},...A?[{name:"logs",title:(0,t.__)("Logs","lean-stats")}]:[]];return(0,e.createElement)(M,{title:(0,t.__)("Settings","lean-stats")},(0,e.createElement)(k,{isLoading:s,error:i,isEmpty:!1,emptyLabel:"",loadingLabel:(0,t.__)("Loading settings…","lean-stats"),skeletonRows:6}),!s&&!i&&(0,e.createElement)(n.TabPanel,{tabs:G},a=>"logs"===a.name?(0,e.createElement)(W,{debugEnabled:A}):(0,e.createElement)("div",{className:"ls-settings-form"},y&&(0,e.createElement)(n.Notice,{status:y.status,isDismissible:!1},y.message),B&&(0,e.createElement)(n.Notice,{status:B.status,isDismissible:!1},B.message),(0,e.createElement)(n.Card,{className:"ls-settings-section"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,t.__)("General","lean-stats")),(0,e.createElement)(n.TextControl,{label:(0,t.__)("Plugin name (menu and dashboard)","lean-stats"),help:(0,t.__)('Leave blank to use "Lean Stats".',"lean-stats"),value:c.plugin_label,onChange:e=>d(a=>({...a,plugin_label:e}))}))),(0,e.createElement)(n.Card,{className:"ls-settings-section"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,t.__)("Geolocation","lean-stats")),(0,e.createElement)("p",null,(0,t.__)("Geolocation aggregation requires MaxMind GeoLite credentials.","lean-stats")),(0,e.createElement)(n.ToggleControl,{label:(0,t.__)("Enable geolocation aggregation","lean-stats"),help:(0,t.__)("Aggregates country, region, and city data in analytics dashboards.","lean-stats"),checked:Boolean(c.geo_aggregation_enabled),onChange:e=>{d(a=>({...a,geo_aggregation_enabled:e})),e||f(e=>({...e,maxmind_account_id:null,maxmind_license_key:null}))}}),(0,e.createElement)(n.TextControl,{label:(0,t.__)("MaxMind Account ID","lean-stats"),type:"text",disabled:!c.geo_aggregation_enabled,help:w.maxmind_account_id||(0,t.__)("Numeric Account ID for MaxMind IP geolocation.","lean-stats"),value:c.maxmind_account_id,onChange:e=>{d(a=>({...a,maxmind_account_id:e})),w.maxmind_account_id&&f(e=>({...e,maxmind_account_id:null}))},isInvalid:Boolean(w.maxmind_account_id)}),(0,e.createElement)(n.TextControl,{label:(0,t.__)("MaxMind License Key","lean-stats"),type:"password",disabled:!c.geo_aggregation_enabled,help:w.maxmind_license_key||(0,t.__)("License Key for MaxMind IP geolocation.","lean-stats"),value:c.maxmind_license_key,onChange:e=>{d(a=>({...a,maxmind_license_key:e})),w.maxmind_license_key&&f(e=>({...e,maxmind_license_key:null}))},isInvalid:Boolean(w.maxmind_license_key)}))),(0,e.createElement)(n.Card,{className:"ls-settings-section"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,t.__)("Privacy & consent","lean-stats")),(0,e.createElement)(n.ToggleControl,{label:(0,t.__)("Respect DNT / GPC","lean-stats"),help:(0,t.__)("Ignore tracking if the browser sends DNT or GPC.","lean-stats"),checked:c.respect_dnt_gpc,onChange:e=>d(a=>({...a,respect_dnt_gpc:e}))}),(0,e.createElement)(n.ToggleControl,{label:(0,t.__)("Debug mode","lean-stats"),help:(0,t.__)("Enables detailed console logs and raw log capture.","lean-stats"),checked:c.debug_enabled,onChange:e=>d(a=>({...a,debug_enabled:e,raw_logs_enabled:e}))}),(0,e.createElement)(n.TextControl,{label:(0,t.__)("Retention window (days)","lean-stats"),type:"number",min:1,max:365,value:String(c.raw_logs_retention_days),help:(0,t.__)("Raw logs purge automatically after the configured window.","lean-stats"),onChange:e=>{const a=Number.parseInt(e,10);d(e=>({...e,raw_logs_retention_days:Number.isNaN(a)?e.raw_logs_retention_days:a}))}}))),(0,e.createElement)(n.Card,{className:"ls-settings-section"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,t.__)("URL cleaning","lean-stats")),(0,e.createElement)(n.ToggleControl,{label:(0,t.__)("Strip query parameters","lean-stats"),help:(0,t.__)("Remove query parameters from tracked URLs.","lean-stats"),checked:c.url_strip_query,onChange:e=>d(a=>({...a,url_strip_query:e}))}),(0,e.createElement)(n.TextControl,{label:(0,t.__)("Query parameter allowlist","lean-stats"),help:(0,t.__)("Comma-separated list of allowed query keys (used for URL tracking and UTM aggregation).","lean-stats"),value:m,onChange:e=>{_(e);const a=e.split(",").map(e=>e.trim()).filter(Boolean);d(e=>({...e,url_query_allowlist:a}))}}))),(0,e.createElement)(n.Card,{className:"ls-settings-section"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,t.__)("Exclusions","lean-stats")),(0,e.createElement)(n.TextareaControl,{label:(0,t.__)("Excluded paths","lean-stats"),help:(0,t.__)("One per line or comma-separated (e.g., /privacy, /account).","lean-stats"),value:p,onChange:e=>{b(e);const a=e.split(/[\n,]+/).map(e=>e.trim()).filter(Boolean);d(e=>({...e,excluded_paths:a}))}}),(0,e.createElement)("div",null,(0,e.createElement)("p",{className:"ls-settings-roles__title"},(0,t.__)("Role exclusions","lean-stats")),(0,e.createElement)("p",null,(0,t.__)("Select roles to exclude from tracking. Select all roles to ignore all logged-in users.","lean-stats")),(0,e.createElement)("div",{className:"ls-settings-roles__list"},0===R.length&&(0,e.createElement)("p",null,(0,t.__)("No roles available.","lean-stats")),R.map(a=>(0,e.createElement)(n.CheckboxControl,{key:a.key,label:a.label,checked:c.excluded_roles.includes(a.key),onChange:e=>{d(t=>{const n=new Set(t.excluded_roles);return e?n.add(a.key):n.delete(a.key),{...t,excluded_roles:Array.from(n)}})}})))))),(0,e.createElement)(n.Card,{className:"ls-settings-section"},(0,e.createElement)(n.CardBody,null,(0,e.createElement)("h3",{className:"ls-settings-section__title"},(0,t.__)("Data management","lean-stats")),(0,e.createElement)("p",null,(0,t.__)("Remove all aggregated analytics and raw log entries.","lean-stats")),(0,e.createElement)(n.Button,{variant:"secondary",isDestructive:!0,onClick:()=>x(!0)},(0,t.__)("Purge analytics data","lean-stats")))),(0,e.createElement)(n.Button,{variant:"primary",isBusy:h,onClick:I,"aria-label":(0,t.__)("Save settings","lean-stats")},(0,t.__)("Save","lean-stats")),N&&(0,e.createElement)(n.Modal,{title:(0,t.__)("Confirm data purge","lean-stats"),onRequestClose:()=>x(!1)},(0,e.createElement)("p",null,(0,t.__)("This action permanently removes all stored analytics and raw logs. Settings remain unchanged.","lean-stats")),(0,e.createElement)("div",{className:"ls-settings-modal__actions"},(0,e.createElement)(n.Button,{variant:"secondary",onClick:()=>x(!1)},(0,t.__)("Cancel","lean-stats")),(0,e.createElement)(n.Button,{variant:"primary",isDestructive:!0,isBusy:L,onClick:D},(0,t.__)("Purge now","lean-stats")))))))},J=()=>(0,e.createElement)(B,{title:(0,t.__)("Top pages","lean-stats"),labelHeader:(0,t.__)("Url","lean-stats"),endpoint:"/top-pages",emptyLabel:(0,t.__)("No popular pages available.","lean-stats"),labelFallback:"/",supportsPageLabelToggle:!0}),Y=()=>(0,e.createElement)(B,{title:(0,t.__)("Top 404s","lean-stats"),labelHeader:(0,t.__)("Url","lean-stats"),endpoint:"/404s",emptyLabel:(0,t.__)("No missing pages available.","lean-stats"),labelFallback:"/"}),X=()=>(0,e.createElement)(B,{title:(0,t.__)("Entry pages (approx.)","lean-stats"),labelHeader:(0,t.__)("Url","lean-stats"),endpoint:"/entry-pages",emptyLabel:(0,t.__)("No entry pages available.","lean-stats"),labelFallback:"/",metricLabel:(0,t.__)("Entries (approx.)","lean-stats"),metricKey:"entries",metricValueKey:"entries",supportsPageLabelToggle:!0}),Q=()=>(0,e.createElement)(B,{title:(0,t.__)("Exit pages (approx.)","lean-stats"),labelHeader:(0,t.__)("Url","lean-stats"),endpoint:"/exit-pages",emptyLabel:(0,t.__)("No exit pages available.","lean-stats"),labelFallback:"/",metricLabel:(0,t.__)("Exits (approx.)","lean-stats"),metricKey:"exits",metricValueKey:"exits",supportsPageLabelToggle:!0}),ee=()=>{const a=[{name:"top-pages",title:(0,t.__)("Top pages","lean-stats")},{name:"entry-pages",title:(0,t.__)("Entry pages","lean-stats")},{name:"exit-pages",title:(0,t.__)("Exit pages","lean-stats")},{name:"not-found",title:(0,t.__)("Pages not found (404)","lean-stats")}];return(0,e.createElement)(n.TabPanel,{className:"ls-pages-tabs",tabs:a},a=>"entry-pages"===a.name?(0,e.createElement)(X,null):"exit-pages"===a.name?(0,e.createElement)(Q,null):"not-found"===a.name?(0,e.createElement)(Y,null):(0,e.createElement)(J,null))},ae=document.getElementById("lean-stats-admin");ae&&(0,a.render)((0,e.createElement)(s,null,(0,e.createElement)(()=>{var l;const s=Boolean(null!==(l=window.LEAN_STATS_DEBUG)&&void 0!==l?l:r?.settings?.debugEnabled),o=(0,a.useMemo)(()=>g({debugEnabled:s}),[s]),c=(e=>{if(!Array.isArray(e))return i;const a=e.map(e=>({name:e?.name||"",title:e?.title||e?.name||""})).filter(e=>e.name);return a.length>0?a:i})(r?.panels),d=r?.currentPanel||"dashboard",m=(e=>{const a={dashboard:H,"top-pages":ee,referrers:q,"search-terms":O,geolocation:I,settings:Z};return a[e]?a[e]:(window.LeanStatsAdminPanels||{})[e]||null})(d),p=((e,a)=>{const n=a.find(a=>a.name===e);return n?.title||(0,t.__)("Lean Stats","lean-stats")})(d,c),b=r?.settings?.pluginLabel||(0,t.__)("Lean Stats","lean-stats");return(0,a.useEffect)(()=>{(e=>{window&&window.addEventListener&&(window.addEventListener("error",a=>{e.error("Global error captured",{action:"window.error",message:a.message,filename:a.filename,lineno:a.lineno,colno:a.colno,error:a.error?a.error.toString():void 0})}),window.addEventListener("unhandledrejection",a=>{e.error("Unhandled promise rejection",{action:"window.unhandledrejection",reason:a.reason?a.reason.toString():void 0})}))})(o),o.info("Loading admin interface",{action:"admin.init",traceId:u(),context:_()})},[o]),r?(0,e.createElement)("div",{className:"ls-admin-app"},(0,e.createElement)("h1",null,b),m?(0,e.createElement)(m,{panel:{name:d,title:p}}):(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,t.__)("No panel available for this screen.","lean-stats"))):(0,e.createElement)(n.Notice,{status:"error",isDismissible:!1},(0,t.__)("Missing admin configuration.","lean-stats"))},null)),ae)})();